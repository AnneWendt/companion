<!DOCTYPE html>
<html>
<head>
<script src="/socket.io/socket.io.js"></script>
<script>
	var socket = io();
	var config;

	socket.on('serial ids', function (data) {
		var select = document.getElementById("serialPorts");
		var lines = data.trim().split('\n');
		lines.forEach(function(line) {
			var option = document.createElement('option');
			option.value = line;
			option.innerHTML = line;
			select.appendChild(option);
			console.log(line);
		});
	});
	
	// Populate current endpoint configuration
	// Routing application responds with current configuration after every request
	socket.on('endpoints', function (data) {
		config = JSON.parse(data);
		var endpoints = document.getElementById('endpoints');
		
		endpoints.innerHTML = "";

		var selectEndpoints = document.createElement('select');
		
		config.endpoints.forEach(function(endpoint) {
			console.log(endpoint);
			var option = document.createElement('option');
			option.value = endpoint.id;
			option.innerHTML = endpoint.id;
			selectEndpoints.append(option);
			
			var h = document.createElement('h3');
			h.innerHTML = "ID: " + endpoint.id;
			endpoints.appendChild(h);
			
			var remove = document.createElement('button');
			remove.innerHTML = "Remove";
			remove.onclick = function() { removeEndpoint(endpoint.id) };
			h.appendChild(remove);

			var l = document.createElement('li');
			l.innerHTML = "Type: " + endpoint.type;
			endpoints.appendChild(l);

			if (endpoint.ip) {
				var l = document.createElement('li');
				l.innerHTML = "IP address: " + endpoint.ip;
				endpoints.appendChild(l);
			}

			var l = document.createElement('li');
			l.innerHTML = "Port: " + endpoint.port;
			endpoints.appendChild(l);
			
			if (endpoint.baudrate) {
				var l = document.createElement('li');
				l.innerHTML = "baudrate: " + endpoint.baudrate;
			    endpoints.appendChild(l);
			}
			
			var label = document.createElement('label');
			label.innerHTML = "Outbound Connections:";
			endpoints.appendChild(label);
			var ul = document.createElement('ul');
			endpoint.connections.forEach(function(connection) {
				var l = document.createElement('li');
				l.innerHTML = connection;
				
				var button = document.createElement('button');
				button.innerHTML = "Disconnect";
				button.onclick = function () {
					socket.emit('routing request', {
						'request': 'disconnect endpoints',
						'source': endpoint.id,
						'target': connection
					});
				};
				l.appendChild(button);
				ul.appendChild(l);
			});
			endpoints.appendChild(ul);
		})
		
		var source = document.getElementById('source');
		source.innerHTML = selectEndpoints.innerHTML
		var target = document.getElementById('target');
		target.innerHTML = selectEndpoints.innerHTML;
	});
	
	// remove endpoint from communication router, active connections are closed
	function removeEndpoint(id) {
		socket.emit('routing request', {
			'request': 'remove endpoint',
			'id': id
		});
	}
	
	// Request communication router to connect two endpoints, can be uni or bi directional
	function connect() {
		var _type = document.getElementById('direction');
		var type = _type.options[_type.selectedIndex].value;

		var _source = document.getElementById('source');
		var source = _source.options[_source.selectedIndex].value;
		
		var _target = document.getElementById('target');
		var target = _target.options[_target.selectedIndex].value;

		if (type == '---->' || type == '<--->') {
			socket.emit('routing request', {
				'request': 'connect endpoints',
				'source': source,
				'target': target
			});
		};
		
		if (type == '<----' || type == '<--->') {
			socket.emit('routing request', {
				'request': 'connect endpoints',
				'source': target,
				'target': source
			});
		};
	}

	// Request communication router to create a new endpoint
	function addUDPEndpoint() {
		var port = document.getElementById('udpPort').value;

		var ip = document.getElementById('udpIP').value;

		socket.emit('routing request', {
			'request' : 'add endpoint',
			'id' : ip + ":" + port,
			'type' : 'udp',
			'port' : port,
			'ip' : ip,
			'connections' : []
		});
	};

	// Request Communication router to create a new endpoint
	function addSerialEndpoint() {
		var _port = document.getElementById('serialPorts');
		var port = _port.options[_port.selectedIndex].text;

		var baudrate = document.getElementById('baudrate').value;

		socket.emit('routing request', {
			'request' : 'add endpoint',
			'id' : port,
			'type' : 'serial',
			'port' : port,
			'baudrate' : baudrate,
			'connections' : []
		});
	};
	
	function saveAll() {
		var filename = '/home/pi/companion/RPI2/Raspbian/SAVED.conf'
		socket.emit('routing request', {
			'request' : 'save all',
			'filename' : filename
		});
	};
	
	function loadAllSoft() {
		loadAll(soft=true);
	};
	
	function loadAll(soft=false) {
		var filename = 'SAVED.conf'
		socket.emit('routing request', {
			'request' : 'load all',
			'filename' : filename,
			'soft' : soft
		});
	};

	// Populate options on initial load/refresh
	socket.emit('get serial ids');
	socket.emit('routing request', {
		'request': 'get endpoints'
	});
</script>
</head>
<div>
    <div id="serialConfig">
        <h3>New Serial Endpoint:</h3>
        <select id="serialPorts"> Serial Port</select><br>
        <input id="baudrate"> Baud Rate</input><br>
        <button onclick="addSerialEndpoint()">Add Serial Endpoint</button>
        
    </div>
    <div id="udpConfig">
        <h3>New UDP Endpoint:</h3>
        <input id="udpIP"> IP address</input><br>
        <input id="udpPort"> UDP Port</input><br>
        <button onclick="addUDPEndpoint()">Add UDP Endpoint</button>
    </div>
    <div>
        <h2>Endpoints:</h2>
        <div id="endpoints" data-endpoints="654"></div>
    </div>
    <div>
    	<select id="source"></select>
		<select id="direction">
			<option>----></option>
			<option><----</option>
			<option><---></option>
		</select>
		<select id="target"></select>
		<button onclick="connect()">Connect</button>
	</div>
	<div>
		<button onclick="saveAll()">Save Config</button>
		<button onclick="loadAllSoft()">Load Config (Soft)</button>
		<button onclick="loadAll()">Load Config</button>
	</div>


</div>

</html>